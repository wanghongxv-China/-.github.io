<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金牌园中学订货系统 - 真同步版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* 保持之前的样式不变，只添加新的同步状态指示器样式 */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 12px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .sync-connected {
            background: #2ecc71;
            color: white;
        }
        
        .sync-connecting {
            background: #f39c12;
            color: white;
        }
        
        .sync-error {
            background: #e74c3c;
            color: white;
        }
        
        .sync-icon {
            animation: spin 1.5s infinite linear;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .device-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            margin-left: 8px;
        }
        
        .sync-log {
            position: fixed;
            bottom: 70px;
            left: 20px;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 12px;
            padding: 15px;
            font-size: 0.9rem;
            z-index: 999;
            display: none;
        }
        
        .sync-log.active {
            display: block;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .log-timestamp {
            color: #95a5a6;
            font-size: 0.8rem;
            margin-right: 8px;
        }
        
        .device-list {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .device-item {
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <!-- 同步状态指示器 -->
    <div id="sync-indicator" class="sync-indicator sync-connecting">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span id="sync-status-text">正在连接同步网络...</span>
        <span id="device-count" class="device-badge">0台设备</span>
    </div>
    
    <div id="sync-log" class="sync-log">
        <div class="log-header">
            <h4><i class="fas fa-clipboard-list"></i> 同步日志</h4>
            <button id="clear-log" style="background: none; border: none; color: #95a5a6;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div id="log-entries"></div>
    </div>
    
    <!-- 保持之前的HTML结构不变 -->
    <!-- ... 之前的header、用户界面、管理后台等 ... -->
    
    <script>
        // 真正的同步功能实现
        document.addEventListener('DOMContentLoaded', function() {
            // 同步状态元素
            const syncIndicator = document.getElementById('sync-indicator');
            const syncStatusText = document.getElementById('sync-status-text');
            const deviceCount = document.getElementById('device-count');
            const syncLog = document.getElementById('sync-log');
            const logEntries = document.getElementById('log-entries');
            
            // 存储订单数据
            let orders = JSON.parse(localStorage.getItem('orders')) || [];
            
            // 生成唯一设备ID
            const deviceId = 'device_' + Math.random().toString(36).substr(2, 8);
            let peer = null;
            let connections = [];
            
            // 添加日志条目
            function addLogEntry(message) {
                const now = new Date();
                const timestamp = now.toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">${timestamp}</span>
                    ${message}
                `;
                logEntries.prepend(logEntry);
                
                // 显示日志面板
                syncLog.classList.add('active');
                
                // 5秒后自动隐藏
                setTimeout(() => {
                    syncLog.classList.remove('active');
                }, 5000);
            }
            
            // 初始化PeerJS连接
            function initPeerConnection() {
                // 使用更稳定的公共服务器
                peer = new Peer(deviceId, {
                    host: 'peerjs-server.herokuapp.com',
                    secure: true,
                    port: 443,
                    path: '/'
                });
                
                peer.on('open', function(id) {
                    updateSyncStatus('已连接到同步网络', 'sync-connected');
                    addLogEntry(`设备连接成功: ${id}`);
                    
                    // 尝试连接到已知设备
                    connectToKnownDevices();
                });
                
                peer.on('connection', function(conn) {
                    conn.on('open', function() {
                        addLogEntry(`新设备连接: ${conn.peer}`);
                        if (!connections.includes(conn.peer)) {
                            connections.push(conn.peer);
                            updateDeviceCount();
                        }
                        
                        // 发送完整订单数据给新设备
                        conn.send({
                            type: 'full_sync',
                            orders: orders,
                            deviceId: deviceId
                        });
                    });
                    
                    conn.on('data', function(data) {
                        handleSyncData(data);
                    });
                    
                    conn.on('close', function() {
                        connections = connections.filter(id => id !== conn.peer);
                        updateDeviceCount();
                        addLogEntry(`设备断开连接: ${conn.peer}`);
                    });
                    
                    conn.on('error', function(err) {
                        addLogEntry(`连接错误: ${err}`);
                    });
                });
                
                peer.on('error', function(err) {
                    addLogEntry(`同步错误: ${err.type}`);
                    updateSyncStatus('同步连接失败', 'sync-error');
                    
                    // 尝试重新连接
                    setTimeout(initPeerConnection, 5000);
                });
            }
            
            // 连接到已知设备
            function connectToKnownDevices() {
                // 这里应该从服务器获取已知设备列表
                // 简化版：尝试连接几个固定设备
                const knownDevices = [
                    'teacher_device_123',
                    'admin_device_456'
                ];
                
                knownDevices.forEach(deviceId => {
                    if (deviceId !== peer.id) {
                        const conn = peer.connect(deviceId);
                        
                        conn.on('open', function() {
                            addLogEntry(`已连接到设备: ${deviceId}`);
                            if (!connections.includes(deviceId)) {
                                connections.push(deviceId);
                                updateDeviceCount();
                            }
                        });
                        
                        conn.on('data', function(data) {
                            handleSyncData(data);
                        });
                        
                        conn.on('close', function() {
                            connections = connections.filter(id => id !== deviceId);
                            updateDeviceCount();
                            addLogEntry(`设备断开: ${deviceId}`);
                        });
                    }
                });
            }
            
            // 处理同步数据
            function handleSyncData(data) {
                switch(data.type) {
                    case 'full_sync':
                        addLogEntry(`接收到完整数据同步 (来自: ${data.deviceId})`);
                        orders = data.orders;
                        saveOrders();
                        renderOrders();
                        break;
                        
                    case 'new_order':
                        addLogEntry(`接收到新订单: ${data.order.id} (来自: ${data.deviceId})`);
                        orders.push(data.order);
                        saveOrders();
                        renderOrders();
                        break;
                        
                    case 'update_order':
                        addLogEntry(`接收到订单更新: ${data.order.id} (来自: ${data.deviceId})`);
                        const index = orders.findIndex(o => o.id === data.order.id);
                        if (index !== -1) {
                            orders[index] = data.order;
                            saveOrders();
                            renderOrders();
                        }
                        break;
                        
                    case 'delete_order':
                        addLogEntry(`接收到订单删除: ${data.orderId} (来自: ${data.deviceId})`);
                        orders = orders.filter(o => o.id !== data.orderId);
                        saveOrders();
                        renderOrders();
                        break;
                }
            }
            
            // 广播数据给所有连接设备
            function broadcast(data) {
                connections.forEach(deviceId => {
                    const conn = peer.connections[deviceId];
                    if (conn && conn.open) {
                        conn.send(data);
                    }
                });
            }
            
            // 更新同步状态
            function updateSyncStatus(text, statusClass) {
                syncStatusText.textContent = text;
                syncIndicator.className = `sync-indicator ${statusClass}`;
            }
            
            // 更新设备计数
            function updateDeviceCount() {
                deviceCount.textContent = `${connections.length}台设备`;
            }
            
            // 保存订单到本地存储
            function saveOrders() {
                localStorage.setItem('orders', JSON.stringify(orders));
            }
            
            // 渲染订单（示例函数）
            function renderOrders() {
                // 这里应该实现订单的渲染逻辑
                console.log('订单已更新，重新渲染', orders);
                addLogEntry(`本地数据已更新 (${orders.length}个订单)`);
            }
            
            // 初始化同步系统
            initPeerConnection();
            
            // 添加日志清除功能
            document.getElementById('clear-log').addEventListener('click', function() {
                logEntries.innerHTML = '';
            });
            
            // 鼠标悬停时显示日志
            syncIndicator.addEventListener('mouseenter', function() {
                syncLog.classList.add('active');
            });
            
            syncLog.addEventListener('mouseleave', function() {
                setTimeout(() => {
                    syncLog.classList.remove('active');
                }, 2000);
            });
            
            // 订单表单提交处理（示例）
            document.getElementById('order-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 生成新订单
                const newOrder = {
                    id: 'ORD-' + Date.now(),
                    product: document.getElementById('product').value,
                    // 其他订单数据...
                    createdAt: new Date().toISOString()
                };
                
                // 添加到本地
                orders.push(newOrder);
                saveOrders();
                renderOrders();
                
                // 广播给其他设备
                broadcast({
                    type: 'new_order',
                    order: newOrder,
                    deviceId: deviceId
                });
                
                addLogEntry(`新订单已创建并广播: ${newOrder.id}`);
            });
            
            // 模拟同步活动
            setInterval(() => {
                if (connections.length > 0) {
                    broadcast({
                        type: 'heartbeat',
                        deviceId: deviceId,
                        timestamp: Date.now()
                    });
                }
            }, 30000);
        });
    </script>
</body>
</html>
